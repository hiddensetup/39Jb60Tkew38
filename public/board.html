<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications Board</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="js/app.js" defer></script>
</head>
<body>
    <div class="container mt-5">
        <h1>Notifications Board</h1>
        <div class="form-group">
            <label for="floorFilter">Filter by Floor</label>
            <select class="form-control" id="floorFilter">
                <option value="all">All Floors</option>
                <!-- Floors will be populated dynamically -->
            </select>
        </div>
        <div class="list-group" id="notificationsList">
            <!-- Notifications will be populated dynamically -->
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/data');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                // Populate floor filter
                const floorFilter = document.getElementById('floorFilter');
                const floors = [...new Set(data.users.map(user => user.floorNumber))];
                floors.forEach(floor => {
                    const option = document.createElement('option');
                    option.value = floor;
                    option.textContent = floor;
                    floorFilter.appendChild(option);
                });

                // Populate notifications list
                const notificationsList = document.getElementById('notificationsList');

                function updateNotifications(floor) {
                    notificationsList.innerHTML = '';
                    const users = floor === 'all' ? data.users : data.users.filter(user => user.floorNumber === floor);
                    users.forEach(user => {
                        const notifications = user.notifications.slice(-2);
                        const floorItem = document.createElement('a');
                        floorItem.href = '#';
                        floorItem.className = 'list-group-item list-group-item-action';
                        const latestNotification = notifications[0] || {};
                        const previousNotification = notifications[1] || {};

                        floorItem.innerHTML = `
                            <div class="d-flex w-100 justify-content-between">
                                <h5 class="mb-1">${user.floorNumber} - Floor</h5>
                                <small class="text-body-secondary">${latestNotification.dateSent ? new Date(latestNotification.dateSent).toLocaleDateString() : 'N/A'}</small>
                            </div>
                            <p class="mb-1">${latestNotification.message || 'No notifications'}</p>
                            <p class="mb-1">${previousNotification.message || 'No previous notifications'}</p>
                        `;
                        notificationsList.appendChild(floorItem);
                    });
                }

                updateNotifications('all');

                floorFilter.addEventListener('change', (e) => {
                    const selectedFloor = e.target.value;
                    updateNotifications(selectedFloor);
                });

            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Failed to load notifications.');
            }
        });
    </script>
</body>
</html>
